\NeedsTeXFormat{LaTeX2e}[1999/12/01]
\ProvidesPackage{booktemplate-sunrise}
\RequirePackage[explicit]{titlesec}
\RequirePackage{ebgaramond}
\RequirePackage[utf8]{inputenc}
\RequirePackage[english]{babel}
\RequirePackage[T1]{fontenc}
\RequirePackage{etoolbox}
\RequirePackage{graphicx}
\RequirePackage{adjustbox}
\RequirePackage{xcolor}
\RequirePackage[framemethod=tikz]{mdframed}

%%%%%%% Page size, font, general typesetting %%%%%%%
\setstocksize{216.41mm}{154.43mm}
\settrimmedsize{210mm}{148mm}{*}
%% 3.2 mm (top), 6.43 (left or right), 3.21 mm (bottom)
\settrims{3.2mm}{6.43mm}

%% To check what this looks like sans trims:
% \setstocksize{210mm}{148mm}
% \settrimmedsize{210mm}{148mm}{*}
% \settrims{0mm}{0mm}

% To see the outlines of the trims, use the memoir class's
% `showtrims' option in your main tex file:
% \documentclass[11pt,showtrims]{memoir}

\setlrmarginsandblock{20mm}{20mm}{*}
\setulmarginsandblock{18mm}{18mm}{*}
\checkandfixthelayout

%% Typesetting details
% via http://www.khirevich.com/latex/microtype/
\usepackage[activate={true,nocompatibility},
    final,
    tracking=true,
    % kerning=true, % incompatible with lualatex
    % spacing=true, % incompatible with lualatex
    factor=1100,
    stretch=10,
    shrink=10,
    letterspace=0 % used for small caps; the results look very different with pdflatex and lualatex!
    ]{microtype}
\frenchspacing

\setmainfont{EBGaramond}[
    Path=./EBGaramond-0.016/otf/,
    Extension=.otf,
    UprightFont=*12-Regular,
    ItalicFont=*12-Italic,
    SmallCapsFont=*12-AllSC,
    Numbers=OldStyle,
    RawFeature={
        +clig, % italic: ligature of final vowel + s
        +dlig, % T+h
        },
    Renderer=Basic
]
\newfontfamily\fancyfont{EBGaramond}[
    Path=./EBGaramond-0.016/otf/,
    Extension=.otf,
    UprightFont=*12-Regular,
    ItalicFont=*12-Italic,
    SmallCapsFont=*12-AllSC,
    Numbers=OldStyle,
    RawFeature={
        %% Ligatures:
        +dlig, % T+h
        +hlig, % s+t, c+t and italic s+p, s+k 
        %% Swashes (only exist for text in italics):
        +swsh,
        },
    Renderer=Basic
]
\newcommand{\fancyit}[1]{%
    \textit{\fancyfont{}#1}%
}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%%%%%%% Custom design elements %%%%%%%
\newcommand{\chapterstart}[1]{%
    \noindent\textsc{#1}%
}

\newcommand{\sectionrule}{%
\begin{center}
    $\infty$
\end{center}
}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%


%%%%%%% Chapter/section titles %%%%%%%
\newcommand{\allsc}[1]{\textsc{\MakeLowercase{#1}}}
\definecolor{mygray}{gray}{0.65}

%% Chapter titles:
%% Page 1) 
%% Background image + centered chapter title
\makeatletter
\newcommand{\chapterbgpage}[1]{
    % Don't print "Chapter"
    \renewcommand\chapternamenum{}
    \renewcommand\printchaptername{}
    % Don't print the chapter number
    \renewcommand\printchapternum{}
    \renewcommand\chapterheadstart{}
    \renewcommand\afterchapternum{}
    \renewcommand\afterchaptertitle{}
    \renewcommand\printchaptertitle[1]{%
    \begin{tikzpicture}[remember picture, overlay]
    \node at (current page.center) {\includegraphics{#1}};
    \end{tikzpicture}
    \begin{center}%
    \vfill%
    {\huge\color{mygray}\textls{\allsc{##1}}}%
    \vfill%
    \end{center}%
    \cleardoublepage
    }
}
\makechapterstyle{sunchapter}{%
    \chapterbgpage{sunrays-inner.pdf}%
}
%% Add any other chapter backgrounds here:
% \makechapterstyle{namehere-chapter}{%
%     \chapterbgpage{file-name.pdf}%
% }
\makeatother
\chapterstyle{sunchapter}

%% Page 2)
%% Background image frame, text inside the frame and in the bottom half of the page
% Change the margins so the text stays inside the frame:
% https://stackoverflow.com/a/1670572 (CC BY-SA 4.0)
\newenvironment{changemargin}[2]{%
\begin{list}{}{%
\setlength{\topsep}{0pt}%
\setlength{\leftmargin}{#1}%
\setlength{\rightmargin}{#2}%
\setlength{\listparindent}{\parindent}%
\setlength{\itemindent}{\parindent}%
\setlength{\parsep}{\parskip}%
}%
\item[]}{\end{list}}

% Call \chapteropener{text here} for the default version
% or optionally specify a different background file.
\newcommand{\chapteropener}[2][sunrays-outer.pdf]{%
    \cleardoublepage%
    \thispagestyle{empty}%
    \begin{tikzpicture}[remember picture, overlay]%
        \node at (current page.center) {\includegraphics{#1}};%
    \end{tikzpicture}%
    \begin{changemargin}{7mm}{7mm}
    \vspace{0.435\textheight}
    #2
    \end{changemargin}%
    \newpage
}

%% Section title
% Mid-height horizontal rules
% Based on https://tex.stackexchange.com/a/451330 (CC BY-SA 4.0)
\makeatletter
\def\myrulefill#1#2{\leavevmode\leaders\hrule\@height#1\@depth#2\hfill \kern\z@}
\makeatother
\newcommand*\crulefilllower[1][1pt]{\myrulefill{\dimexpr(1ex+#1)/2}{\dimexpr(-1ex+#1)/2}}
\newcommand*\crulefillupper[1][1pt]{\myrulefill
    {\dimexpr(\fontcharht\font`X+#1)/2}{\dimexpr(-\fontcharht\font`X+#1)/2}}
% Section title in fancy italics, between horizontal lines
\titleformat{\section}{}{}{0pt}{\crulefilllower~~~\fancyit{#1}~~~\crulefilllower}

%% Subsection title: horizontally centered
\titleformat{\subsection}{}{}{0pt}{\centering#1}

%% Paragraph title (used for TOC header!)
\titleformat{\paragraph}{}{}{0pt}{\centering\LARGE\allsc{#1}}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%


%%%%%%% Headers/footers %%%%%%%
% Even pages: book title in small caps
% Odd pages: chapter title in italics
% Based on https://tex.stackexchange.com/a/38449 (CC BY-SA 3.0)
\nouppercaseheads
\makepagestyle{mystyle} 
\setlength{\headwidth}{\textwidth}
\makerunningwidth{mystyle}{\headwidth}
\makeevenhead{mystyle}{\thepage}{\allsc\booktitle}{}
\makeoddhead{mystyle}{}{\fancyit\leftmark}{\thepage} 
\makeatletter
\makepsmarks{mystyle}{%
  \createmark{chapter}{left}{nonumber}{}{}
}
\makeatother
\pagestyle{mystyle}

% No page numbers on chapter opening pages
\makeoddfoot{plain}{}{}{}
\chapterstyle{plain}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%


%%%%%%% Front matter pages %%%%%%%
%% Half-title (page that contains just the title)
\newcommand{\halftitlepage}[1][\booktitle]{
    \vspace*{0.4\textheight}
    \begin{center}
    \Huge{\allsc{#1}}
    \end{center}
    \newpage
}

%% "Other books in this series" page
% (Replaces frontispiece)
\newcommand{\otherbookspage}[2]{
    \vspace*{0.428\textheight}%
    \begin{center}%
    {\crulefilllower~~~\allsc{#1}~~~\crulefilllower}\\
    \vspace{10pt}
    % \section*{#1}
    #2
    \end{center}%
    \newpage
}

%% Title page (styled like the cover)
\newcommand{\titlepage}[2]{%
    \cleardoublepage%
    \begin{tikzpicture}[remember picture, overlay]%
    \node at (current page.center) {\includegraphics{sunrays-title.pdf}};%
    \end{tikzpicture}%
\begin{center}
    \vspace{2.2em}
    {\Huge\color{white}\allsc{#1}}\\ % Book title
    \vspace{\fill}
    {\Huge\color{white}\allsc{#2}}\\ % Author
    \vspace{2.2em}
\end{center}
\newpage
}

%% Colophon page
\newcommand{\colophonpage}[1]{
\vspace*{\fill}
\begin{center}
\begin{minipage}{0.69\textwidth}
    \large\fancyit{\booktitle}\\
    #1
    \vspace{-10pt}\begin{flushright}$\infty$\end{flushright}
\end{minipage}
\end{center}
\newpage
}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%


%%%%%%% Front matter style %%%%%%%
% No page numbers in the front matter
% https://tex.stackexchange.com/a/53491 (CC BY-SA 3.0)
\makeatletter
\aliaspagestyle{title}{empty}
\let\origps@chapter\ps@chapter
\preto\frontmatter{\let\ps@chapter\ps@empty\pagestyle{empty}}
\preto\mainmatter{%
  \cleardoublepage
  \let\ps@chapter\origps@chapter\pagestyle{headings}}
\makeatother

%% Table of contents:
% - no chapter/section numbers
\renewcommand{\chapternumberline}[1]{}
\renewcommand{\thesection}{}
% - dots for chapters
\renewcommand{\cftchapterdotsep}{\cftdotsep}
% - include subsections
\setcounter{tocdepth}{2}
% - indent subsections further
\makeatletter
\renewcommand*\l@subsection{\@dottedtocline{1}{6em}{0em}}
% - don't internally call \chapter{}, use a custom title instead:
\renewcommand\@tocmaketitle{%
  \paragraph*{contents}
  \tocmark%
  \@afterheading}
\makeatother
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%


%%%%%%% Main matter %%%%%%%
\newcommand{\startmainmatter}[1][7]{
\mainmatter
\pagestyle{mystyle}
\setcounter{page}{#1}
}
%%%%%%%%%%%%%%%%%%%%%%%%%%%


%%%%%%% Appendix %%%%%%%
\newcommand{\startappendix}{
\cleardoublepage
\chapter{Appendix}
\setcounter{page}{1}
\pagenumbering{roman}
}
%%%%%%%%%%%%%%%%%%%%%%%%


%%%%%%% Hyphenation %%%%%%%
% Minimum extra line length before the compiler starts complaining
\hfuzz=2.3pt

% Ways to fix line breaks:
% - \\
% - \allowbreak{}
% - \- (inserts hyphen if LaTeX breaks the line)
% - \mbox{ ... } (no break!)
% - ~ (non-breaking space)

% Use these when custom hyphenation doesn't do the trick.
% They stretch the whitespace in otherwise too short lines
% (include up to the word before the one that's overlong).
% - \spreadlinePAR is for the indented first line in a paragraph
% - \spreadlineMID is for unindented lines
\newcommand{\spreadlineparnobr}[1]{%
\makebox[\dimexpr\linewidth-\parindent][s]{#1}%
}
\newcommand{\spreadlinepar}[1]{%
\spreadlineparnobr{#1}\\%
}
\newcommand{\spreadlinemidnobr}[1]{%
\makebox[\dimexpr\linewidth][s]{#1}%
}
\newcommand{\spreadlinemid}[1]{%
\spreadlinemidnobr{#1}\\%
}
%%%%%%%%%%%%%%%%%%%%%%%%%%%

\endinput